version: '3.8'

services:
  # ============================================
  # Infrastructure Services
  # ============================================
  
  # Eureka Discovery Server
  discovery-server:
    build:
      context: .
      dockerfile: discovery-server/Dockerfile
    container_name: discovery-server
    ports:
      - "8761:8761"
    networks:
      - microservices-network

  # API Gateway
  api-gateway:
    build:
      context: .
      dockerfile: api-gateway/Dockerfile
    container_name: api-gateway
    ports:
      - "8080:8080"
    environment:
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://discovery-server:8761/eureka/
    depends_on:
      - discovery-server
    networks:
      - microservices-network

  # ============================================
  # Kafka Cluster
  # ============================================
  
  broker-1:
    image: apache/kafka:latest
    hostname: broker-1
    container_name: broker-1
    ports:
      - "9092:9092"
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT,CONTROLLER:PLAINTEXT
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://broker-1:29092,PLAINTEXT_HOST://localhost:9092
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 2
      KAFKA_GROUP_INITIAL_REBALANCE_DELAY_MS: 0
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 1
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 2
      KAFKA_PROCESS_ROLES: broker,controller
      KAFKA_NODE_ID: 1
      KAFKA_CONTROLLER_QUORUM_VOTERS: 1@broker-1:29093,2@broker-2:29093
      KAFKA_LISTENERS: PLAINTEXT://broker-1:29092,CONTROLLER://broker-1:29093,PLAINTEXT_HOST://0.0.0.0:9092
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
      KAFKA_CONTROLLER_LISTENER_NAMES: CONTROLLER
      KAFKA_LOG_DIRS: /var/lib/kafka/data
      CLUSTER_ID: MkU3OEVBNTcwNTJENDM2Qk
      KAFKA_NUM_PARTITIONS: 3
      KAFKA_DEFAULT_REPLICATION_FACTOR: 2
    volumes:
      - broker-1-data:/var/lib/kafka/data
    networks:
      - microservices-network

  broker-2:
    image: apache/kafka:latest
    hostname: broker-2
    container_name: broker-2
    ports:
      - "9093:9093"
    environment:
      KAFKA_BROKER_ID: 2
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT,CONTROLLER:PLAINTEXT
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://broker-2:29092,PLAINTEXT_HOST://localhost:9093
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 2
      KAFKA_GROUP_INITIAL_REBALANCE_DELAY_MS: 0
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 1
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 2
      KAFKA_PROCESS_ROLES: broker,controller
      KAFKA_NODE_ID: 2
      KAFKA_CONTROLLER_QUORUM_VOTERS: 1@broker-1:29093,2@broker-2:29093
      KAFKA_LISTENERS: PLAINTEXT://broker-2:29092,CONTROLLER://broker-2:29093,PLAINTEXT_HOST://0.0.0.0:9093
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
      KAFKA_CONTROLLER_LISTENER_NAMES: CONTROLLER
      KAFKA_LOG_DIRS: /var/lib/kafka/data
      CLUSTER_ID: MkU3OEVBNTcwNTJENDM2Qk
      KAFKA_NUM_PARTITIONS: 3
      KAFKA_DEFAULT_REPLICATION_FACTOR: 2
    volumes:
      - broker-2-data:/var/lib/kafka/data
    networks:
      - microservices-network

  kafka-ui:
    image: provectuslabs/kafka-ui:latest
    container_name: kafka-ui
    ports:
      - "8085:8080"
    environment:
      KAFKA_CLUSTERS_0_NAME: local-cluster
      KAFKA_CLUSTERS_0_BOOTSTRAPSERVERS: broker-1:29092,broker-2:29092
      KAFKA_CLUSTERS_0_PROPERTIES_SECURITY_PROTOCOL: PLAINTEXT
      KAFKA_CLUSTERS_0_READONLY: "false"
    depends_on:
      - broker-1
      - broker-2
    networks:
      - microservices-network

  # ============================================
  # PostgreSQL Databases
  # ============================================
  
  postgres-auth:
    image: postgres:16-alpine
    container_name: postgres-auth
    environment:
      POSTGRES_DB: auth_db
      POSTGRES_USER: ${DB_USERNAME_AUTH:-auth_user}
      POSTGRES_PASSWORD: ${DB_PASSWORD_AUTH:-auth_password}
    ports:
      - "5432:5432"
    volumes:
      - postgres-auth-data:/var/lib/postgresql/data
    networks:
      - microservices-network

  postgres-userprofile:
    image: postgres:16-alpine
    container_name: postgres-userprofile
    environment:
      POSTGRES_DB: userprofile_db
      POSTGRES_USER: ${DB_USERNAME_PROFILE:-userprofile_user}
      POSTGRES_PASSWORD: ${DB_PASSWORD_PROFILE:-userprofile_password}
    ports:
      - "5433:5432"
    volumes:
      - postgres-userprofile-data:/var/lib/postgresql/data
    networks:
      - microservices-network

  postgres-appointment:
    image: postgres:16-alpine
    container_name: postgres-appointment
    environment:
      POSTGRES_DB: appointment_db
      POSTGRES_USER: ${DB_USERNAME_APPOINTMENT:-appointment_user}
      POSTGRES_PASSWORD: ${DB_PASSWORD_APPOINTMENT:-appointment_password}
    ports:
      - "5434:5432"
    volumes:
      - postgres-appointment-data:/var/lib/postgresql/data
    networks:
      - microservices-network

  postgres-scheduling:
    image: postgres:16-alpine
    container_name: postgres-scheduling
    environment:
      POSTGRES_DB: scheduling_db
      POSTGRES_USER: ${DB_USERNAME_SCHEDULING:-scheduling_user}
      POSTGRES_PASSWORD: ${DB_PASSWORD_SCHEDULING:-scheduling_password}
    ports:
      - "5435:5432"
    volumes:
      - postgres-scheduling-data:/var/lib/postgresql/data
    networks:
      - microservices-network

  postgres-payment:
    image: postgres:16-alpine
    container_name: postgres-payment
    environment:
      POSTGRES_DB: payment_db
      POSTGRES_USER: ${DB_USERNAME_PAYMENT:-payment_user}
      POSTGRES_PASSWORD: ${DB_PASSWORD_PAYMENT:-payment_password}
    ports:
      - "5436:5432"
    volumes:
      - postgres-payment-data:/var/lib/postgresql/data
    networks:
      - microservices-network

  postgres-notifications:
    image: postgres:16-alpine
    container_name: postgres-notifications
    environment:
      POSTGRES_DB: notifications_db
      POSTGRES_USER: ${DB_USERNAME_NOTIFICATIONS:-notifications_user}
      POSTGRES_PASSWORD: ${DB_PASSWORD_NOTIFICATIONS:-notifications_password}
    ports:
      - "5437:5432"
    volumes:
      - postgres-notifications-data:/var/lib/postgresql/data
    networks:
      - microservices-network

  postgres-medicalrecord:
    image: postgres:16-alpine
    container_name: postgres-medicalrecord
    environment:
      POSTGRES_DB: medicalrecord_db
      POSTGRES_USER: ${DB_USERNAME_MEDICALRECORD:-medicalrecord_user}
      POSTGRES_PASSWORD: ${DB_PASSWORD_MEDICALRECORD:-medicalrecord_password}
    ports:
      - "5438:5432"
    volumes:
      - postgres-medicalrecord-data:/var/lib/postgresql/data
    networks:
      - microservices-network

  # ============================================
  # Redis for Caching
  # ============================================
  
  redis:
    image: redis:7-alpine
    container_name: redis
    ports:
      - "6379:6379"
    command: redis-server --requirepass ${REDIS_PASSWORD:-NguyenLuong1405}
    volumes:
      - redis-data:/data
    networks:
      - microservices-network

  # ============================================
  # MinIO for File Service
  # ============================================
  
  minio:
    image: minio/minio:latest
    container_name: minio
    ports:
      - "9000:9000"
      - "9001:9001"
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER:-nqluong1405}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD:-nqluong140504}
    volumes:
      - minio-data:/data
    command: server /data --console-address ":9001"
    networks:
      - microservices-network

  # ============================================
  # Business Services
  # ============================================
  
  # Auth Service
  auth-service:
    build:
      context: .
      dockerfile: auth-service/Dockerfile
    container_name: auth-service
    environment:
      - DB_URL_AUTH=postgresql://postgres-auth:5432/auth_db
      - DB_USERNAME_AUTH=${DB_USERNAME_AUTH:-auth_user}
      - DB_PASSWORD_AUTH=${DB_PASSWORD_AUTH:-auth_password}
      - KAFKA_BOOTSTRAP_SERVERS=broker-1:29092,broker-2:29092
      - SECRET_KEY_JWT=${SECRET_KEY_JWT:-your-secret-key-here-change-in-production}
      - ADMIN_USER_NAME=${ADMIN_USER_NAME:-admin}
      - ADMIN_PASSWORD=${ADMIN_PASSWORD:-admin123}
      - DEFAULT_ROLE_ID=${DEFAULT_ROLE_ID:-6e64fe22-a593-4c2e-9fad-9ae101a47e82}
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://discovery-server:8761/eureka/
    depends_on:
      - discovery-server
      - postgres-auth
      - broker-1
      - broker-2
    networks:
      - microservices-network
    volumes:
      - auth-uploads:/app/uploads

  # User Profile Service
  userprofile-service:
    build:
      context: .
      dockerfile: userprofile-service/Dockerfile
    container_name: userprofile-service
    environment:
      - DB_URL_PROFILE=postgresql://postgres-userprofile:5432/userprofile_db
      - DB_USERNAME_PROFILE=${DB_USERNAME_PROFILE:-userprofile_user}
      - DB_PASSWORD_PROFILE=${DB_PASSWORD_PROFILE:-userprofile_password}
      - KAFKA_BOOTSTRAP_SERVERS=broker-1:29092,broker-2:29092
      - REDIS_HOST=${REDIS_HOST:-redis}
      - REDIS_PORT=${REDIS_PORT:-6379}
      - REDIS_PASSWORD=${REDIS_PASSWORD:-NguyenLuong1405}
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://discovery-server:8761/eureka/
    depends_on:
      - discovery-server
      - postgres-userprofile
      - redis
      - broker-1
      - broker-2
    networks:
      - microservices-network

  # Appointment Service
  appointment-service:
    build:
      context: .
      dockerfile: appointment-service/Dockerfile
    container_name: appointment-service
    environment:
      - DB_URL_APPOINTMENT=postgresql://postgres-appointment:5432/appointment_db
      - DB_USERNAME_APPOINTMENT=${DB_USERNAME_APPOINTMENT:-appointment_user}
      - DB_PASSWORD_APPOINTMENT=${DB_PASSWORD_APPOINTMENT:-appointment_password}
      - KAFKA_BOOTSTRAP_SERVERS=broker-1:29092,broker-2:29092
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://discovery-server:8761/eureka/
    depends_on:
      - discovery-server
      - postgres-appointment
      - broker-1
      - broker-2
    networks:
      - microservices-network

  # Scheduling Service
  scheduling-service:
    build:
      context: .
      dockerfile: scheduling-service/Dockerfile
    container_name: scheduling-service
    environment:
      - DB_URL_SCHEDULING=postgresql://postgres-scheduling:5432/scheduling_db
      - DB_USERNAME_SCHEDULING=${DB_USERNAME_SCHEDULING:-scheduling_user}
      - DB_PASSWORD_SCHEDULING=${DB_PASSWORD_SCHEDULING:-scheduling_password}
      - KAFKA_BOOTSTRAP_SERVERS=broker-1:29092,broker-2:29092
      - REDIS_HOST=${REDIS_HOST:-redis}
      - REDIS_PORT=${REDIS_PORT:-6379}
      - REDIS_PASSWORD=${REDIS_PASSWORD:-NguyenLuong1405}
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://discovery-server:8761/eureka/
    depends_on:
      - discovery-server
      - postgres-scheduling
      - redis
      - broker-1
      - broker-2
    networks:
      - microservices-network

  # Payment Service
  payment-service:
    build:
      context: .
      dockerfile: payment-service/Dockerfile
    container_name: payment-service
    environment:
      - DB_URL_PAYMENT=postgresql://postgres-payment:5432/payment_db
      - DB_USERNAME_PAYMENT=${DB_USERNAME_PAYMENT:-payment_user}
      - DB_PASSWORD_PAYMENT=${DB_PASSWORD_PAYMENT:-payment_password}
      - KAFKA_BOOTSTRAP_SERVERS=broker-1:29092,broker-2:29092
      - TMN_CODE=${TMN_CODE:-your-vnpay-tmn-code}
      - PAY_URL=${PAY_URL:-https://sandbox.vnpayment.vn/paymentv2/vpcpay.html}
      - SECRET_KEY=${SECRET_KEY:-your-vnpay-secret-key}
      - RETURN_URL=${RETURN_URL:-http://localhost:8080/api/payments/vnpay-return}
      - REFUND_URL=${REFUND_URL:-https://sandbox.vnpayment.vn/merchant_webapi/api/transaction}
      - QUERY_URL=${QUERY_URL:-https://sandbox.vnpayment.vn/merchant_webapi/api/transaction}
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://discovery-server:8761/eureka/
    depends_on:
      - discovery-server
      - postgres-payment
      - broker-1
      - broker-2
    networks:
      - microservices-network

  # Notifications Service
  notifications-service:
    build:
      context: .
      dockerfile: notifications-service/Dockerfile
    container_name: notifications-service
    environment:
      - DB_URL_NOTIFICATIONS=postgresql://postgres-notifications:5432/notifications_db
      - DB_USERNAME_NOTIFICATIONS=${DB_USERNAME_NOTIFICATIONS:-notifications_user}
      - DB_PASSWORD_NOTIFICATIONS=${DB_PASSWORD_NOTIFICATIONS:-notifications_password}
      - KAFKA_BOOTSTRAP_SERVERS=broker-1:29092,broker-2:29092
      - PASS_MAIL=${PASS_MAIL:-your-gmail-app-password}
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://discovery-server:8761/eureka/
    depends_on:
      - discovery-server
      - postgres-notifications
      - broker-1
      - broker-2
    networks:
      - microservices-network

  # Medical Record Service
  medicalrecord-service:
    build:
      context: .
      dockerfile: medicalrecord-service/Dockerfile
    container_name: medicalrecord-service
    environment:
      - DB_URL_MEDICALRECORD=postgresql://postgres-medicalrecord:5432/medicalrecord_db
      - DB_USERNAME_MEDICALRECORD=${DB_USERNAME_MEDICALRECORD:-medicalrecord_user}
      - DB_PASSWORD_MEDICALRECORD=${DB_PASSWORD_MEDICALRECORD:-medicalrecord_password}
      - KAFKA_BOOTSTRAP_SERVERS=broker-1:29092,broker-2:29092
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://discovery-server:8761/eureka/
    depends_on:
      - discovery-server
      - postgres-medicalrecord
      - broker-1
      - broker-2
    networks:
      - microservices-network

  # File Service
  file-service:
    build:
      context: .
      dockerfile: file-service/Dockerfile
    container_name: file-service
    environment:
      - MINIO_ENDPOINT=${MINIO_ENDPOINT:-http://minio:9000}
      - MINIO_ACCESS_KEY=${MINIO_ACCESS_KEY:-nqluong1405}
      - MINIO_SECRET_KEY=${MINIO_SECRET_KEY:-nqluong140504}
      - KAFKA_BOOTSTRAP_SERVERS=broker-1:29092,broker-2:29092
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://discovery-server:8761/eureka/
    depends_on:
      - discovery-server
      - minio
      - broker-1
      - broker-2
    networks:
      - microservices-network


volumes:
  broker-1-data:
  broker-2-data:
  redis-data:
  postgres-auth-data:
  postgres-userprofile-data:
  postgres-appointment-data:
  postgres-scheduling-data:
  postgres-payment-data:
  postgres-notifications-data:
  postgres-medicalrecord-data:
  minio-data:
  auth-uploads:

networks:
  microservices-network:
    driver: bridge
